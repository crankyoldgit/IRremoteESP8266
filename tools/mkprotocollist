#!/bin/bash
# Generate the 'SupportedProtocols.md' file for the library.
# Expects to run from the top directory of the git respository.

# Set the locale for sorting
export LC_ALL=C
TIMESTAMP=$(date -u)
CODEURL="https://github.com/markszabo/IRremoteESP8266/blob/master/src/ir_"
cat << EndOfTextEndOfTextEndOfText
<!--- WARNING: Do NOT edit this file directly.
      It is generated by 'tools/mkprotocollist'.
      Last generated: ${TIMESTAMP} --->
EndOfTextEndOfTextEndOfText

echo "# IR Protocols supported by this library"
ALL=$(cat src/IRremoteESP8266.h | while read a b; do
          if [[ ${a} == "};" ]]; then
            ENUM=0;
          fi;
          if [[ ${ENUM} -eq 1 ]]; then
            model=$(echo $a | cut -d' ' -f2)
            [[ "$model" != "UNKNOWN" && "$model" != "UNUSED" && "$model" != "kLastDecodeType" && "$model" != "//" ]] && echo "$model" | sed 's/,//g';
          fi;
          if [[ ${a} == "enum" ]]; then
            ENUM=1;
          fi;
        done | sort -du)

DECODEPROTOCOLS=$(
    egrep "^ *results->decode_type = " src/*.cpp |
    sed 's/.*results->decode_type *= *//;s/decode_type_t:://;s/;//' |
    grep -v "^UNKNOWN$" | sort -du)

echo
echo "## Send only protocols:"
echo
for proto in ${ALL}; do
  sendonly="y"
  for decode in ${DECODEPROTOCOLS}; do
    [[ "${proto}" == "${decode}" ]] && sendonly="n" && break
  done
  [[ "${sendonly}" == "y" ]] && echo "- $proto"
done

echo
echo "## Send & decodable protocols:"
echo
for proto in ${DECODEPROTOCOLS}; do
  echo "- ${proto}"
done

echo
echo "## A/C protocols with detailed support:"
echo

FULLAC=""
for header in src/ir_*.h ; do
  protocol=$(echo $header | sed 's,src/ir_,,;s/\.h$//')
  ENUMS=$(cat $header | while read a b; do
          if [[ ${a} == "};" ]]; then
            ENUM=0;
          fi;
          if [[ ${ENUM} -eq 1 ]]; then
            model=$(echo $a | tr [:lower:] [:upper:] | sed "s/^k${protocol}//i")
            [[ "$model" != "UNKNOWN" ]] && echo -n "$model " | sed 's/,//g';
          fi;
          if [[ ${a} == "enum" ]]; then
            ENUM=1;
          fi;
        done)
  egrep -q "^ *class *[^ ]+ *{" $header
  if [[ $? -eq 0 ]]; then
    echo "- [${protocol}](${CODEURL}${protocol}.h)"
    [[ ! -z "${ENUMS}" ]] && echo "  - Models: ${ENUMS}"
  fi
done
